# üöÄ –î–µ–ø–ª–æ–π Day 2: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

**–î–∞—Ç–∞:** 6 –¥–µ–∫–∞–±—Ä—è 2025  
**–ö–æ–º–º–∏—Ç—ã:** d522299, b6896ed  
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è + —Ü–µ–Ω—ã —É—Å–ª—É–≥

---

## üì¶ –ß—Ç–æ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `database/models/reminder.py` - –Ω–æ–≤—ã–µ —Ç–∏–ø—ã reminder + –ø–æ–ª–µ extra_data
2. `services/notifications.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ RESCHEDULED –∏ CANCELLED_BY_MASTER
3. `bot/handlers/api.py` - —Å–æ–∑–¥–∞–Ω–∏–µ immediate reminders –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
4. `webapp/appointments.js` - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω —É—Å–ª—É–≥

---

## üîß –®–∞–≥–∏ –¥–µ–ø–ª–æ—è –Ω–∞ VPS

### 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ VPS
```bash
ssh root@v2992624.hosted-by-vdsina.ru
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
```bash
cd /var/www/BeautyAssist
git pull origin main
```

–î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤—ã–≤–æ–¥:
```
From https://github.com/rosavskiy/BeautyAssist
   bc676c6..b6896ed  main -> main
Updating bc676c6..b6896ed
Fast-forward
 WEEK_PLAN_DEC_6-13.md             |  67 +++++++++++++---
 bot/handlers/api.py               |  55 ++++++++++---
 database/models/reminder.py       |  12 +++
 services/notifications.py         |  28 +++++++
 webapp/appointments.js            |   3 +
 5 files changed, 147 insertions(+), 18 deletions(-)
```

### 3. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```bash
source venv/bin/activate
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
```bash
pip list | grep -E "aiogram|sqlalchemy|asyncpg"
```

### 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ë–î
alembic current

# –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ reminders –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—É—é —Å—Ö–µ–º—É
# –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è extra_data –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º alembic upgrade
```

**–í–ê–ñ–ù–û:** –ù–∞ production –ë–î –ø—É—Å—Ç–∞—è, –ø–æ—ç—Ç–æ–º—É –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è `extra_data` –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –ø–æ–ª–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `alembic upgrade head` –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ö–µ–º—ã —Å –Ω—É–ª—è.

### 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
sudo systemctl restart beautyassist-bot
```

### 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
```bash
sudo systemctl status beautyassist-bot
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: **Active: active (running)**

### 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
tail -f /var/www/BeautyAssist/logs/bot.log
```

–ò–ª–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è journalctl:
```bash
sudo journalctl -u beautyassist-bot -f
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç 1: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ –º–∞—Å—Ç–µ—Ä–æ–º

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ WebApp
2. –ú–∞—Å—Ç–µ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ Mini App (–∏–ª–∏ API)
3. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-5 –º–∏–Ω—É—Ç

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:**
```
INFO - Created cancellation reminder for client {telegram_id}, appointment {app_id}
INFO - Sent reminder: CANCELLED_BY_MASTER to {telegram_id}
```

**–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É:**
```
‚ùå –ú–∞—Å—Ç–µ—Ä –æ—Ç–º–µ–Ω–∏–ª –∑–∞–ø–∏—Å—å

–î–∞—Ç–∞: 7 –¥–µ–∫–∞–±—Ä—è 2025, 14:00
–£—Å–ª—É–≥–∞: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π

–ü—Ä–∏—á–∏–Ω–∞: [–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞]

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞: /start
```

### –¢–µ—Å—Ç 2: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–ø–∏—Å–∏ –º–∞—Å—Ç–µ—Ä–æ–º

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –Ω–∞ 14:00
2. –ú–∞—Å—Ç–µ—Ä –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –∑–∞–ø–∏—Å—å –Ω–∞ 16:00 —á–µ—Ä–µ–∑ API
3. **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –≤—Ä–µ–º–µ–Ω–µ–º

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:**
```
INFO - Created reschedule reminder for client {telegram_id}, appointment {app_id}
INFO - Sent reminder: RESCHEDULED to {telegram_id}
```

**–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É:**
```
üîÑ –ú–∞—Å—Ç–µ—Ä –ø–µ—Ä–µ–Ω–µ—Å –≤–∞—à—É –∑–∞–ø–∏—Å—å

–ë—ã–ª–æ: 7 –¥–µ–∫–∞–±—Ä—è 2025, 14:00
–°—Ç–∞–ª–æ: 7 –¥–µ–∫–∞–±—Ä—è 2025, 16:00

–£—Å–ª—É–≥–∞: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π
```

### –¢–µ—Å—Ç 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –û—Ç–∫—Ä—ã—Ç—å appointments.html –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç
2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –ü–æ–¥ –≤—Ä–µ–º–µ–Ω–µ–º –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ü–µ–Ω–∞: `üí∞ 1000 ‚ÇΩ`
- –¶–µ–Ω–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ `service.price`

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:** Cron job –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç immediate reminders

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ cron job –Ω–∞—Å—Ç—Ä–æ–µ–Ω
crontab -l | grep send_due_reminders

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
# */5 * * * * cd /var/www/BeautyAssist && venv/bin/python -m scripts.send_reminders

# –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–∏—Ç—å:
crontab -e
# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É:
*/5 * * * * cd /var/www/BeautyAssist && venv/bin/python -m scripts.send_reminders >> /var/www/BeautyAssist/logs/cron.log 2>&1
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å systemd timer:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status beautyassist-reminders.timer
sudo systemctl status beautyassist-reminders.service

# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω
sudo systemctl enable beautyassist-reminders.timer
sudo systemctl start beautyassist-reminders.timer
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –¢–∞–±–ª–∏—Ü–∞ reminders –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è, –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
```bash
cd /var/www/BeautyAssist
source venv/bin/activate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞
psql -U beautyassist -d beautyassist -c "\dt reminders"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—à–∏–±–∫–∞ "column extra_data does not exist"

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å—Ç–∞—Ä–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π –±–µ–∑ extra_data

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql -U beautyassist -d beautyassist

-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤—Ä—É—á–Ω—É—é
ALTER TABLE reminders ADD COLUMN extra_data JSON;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
\d reminders
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π > 10 –º–∏–Ω—É—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** Cron job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–µ–¥–∫–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 15-30 –º–∏–Ω—É—Ç)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É cron job –Ω–∞ –∫–∞–∂–¥—ã–µ 1-2 –º–∏–Ω—É—Ç—ã
crontab -e
# –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞:
*/1 * * * * cd /var/www/BeautyAssist && venv/bin/python -m scripts.send_reminders >> /var/www/BeautyAssist/logs/cron.log 2>&1
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql -U beautyassist -d beautyassist

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ immediate reminders
SELECT 
    id, 
    appointment_id, 
    reminder_type, 
    scheduled_time, 
    sent_at,
    extra_data
FROM reminders 
WHERE reminder_type IN ('rescheduled', 'cancelled_by_master')
ORDER BY created_at DESC 
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ reminders –≤ –æ—á–µ—Ä–µ–¥–∏ (–µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã)
SELECT 
    reminder_type,
    COUNT(*) as count
FROM reminders 
WHERE sent_at IS NULL 
  AND scheduled_time <= NOW()
GROUP BY reminder_type;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ immediate reminders
SELECT 
    reminder_type,
    AVG(EXTRACT(EPOCH FROM (sent_at - scheduled_time))) as avg_delivery_seconds
FROM reminders 
WHERE reminder_type IN ('rescheduled', 'cancelled_by_master')
  AND sent_at IS NOT NULL
GROUP BY reminder_type;
```

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏ –º–∞—Å—Ç–µ—Ä–æ–º
- ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–ø–∏—Å–∏ –º–∞—Å—Ç–µ—Ä–æ–º
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1-5 –º–∏–Ω—É—Ç
- ‚úÖ –¶–µ–Ω—ã —É—Å–ª—É–≥ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ appointments.html
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö cron job
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ reminders —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å–∏ —Å extra_data

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

### –û—Ç–∫–∞—Ç –∫–æ–¥–∞
```bash
cd /var/www/BeautyAssist
git log --oneline -5
# –ù–∞–π—Ç–∏ –∫–æ–º–º–∏—Ç bc676c6 (–ø–µ—Ä–µ–¥ Day 2 –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏)
git reset --hard bc676c6
sudo systemctl restart beautyassist-bot
```

### –û—Ç–∫–∞—Ç –ë–î (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ extra_data –≤—Ä—É—á–Ω—É—é)
```sql
ALTER TABLE reminders DROP COLUMN IF EXISTS extra_data;
```

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ production
2. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ü–µ–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
4. üéØ –ù–∞—á–∞—Ç—å Day 3: Finances Mini App

---

**–°–æ—Å—Ç–∞–≤–ª–µ–Ω–æ:** 6 –¥–µ–∫–∞–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** Ready to deploy
