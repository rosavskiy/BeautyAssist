# –î–æ—Å—Ç—É–ø –∫ Admin Analytics Dashboard

## üîê –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–º–∏–Ω–æ–≤

–í —Ñ–∞–π–ª–µ `.env` —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:

```env
ADMIN_TELEGRAM_IDS=123456789,987654321
```

–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –¢–æ–ª—å–∫–æ —ç—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º.

### 2. –°–ø–æ—Å–æ–±—ã –æ—Ç–∫—Ä—ã—Ç–∏—è Analytics Dashboard

#### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É `/admin`
2. –ü–æ—è–≤–∏—Ç—Å—è –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏:
   ```
   üìä Dashboard
   üë• –ú–∞—Å—Ç–µ—Ä–∞ | üì£ –†–∞—Å—Å—ã–ª–∫–∞
   üé´ –ü—Ä–æ–º–æ–∫–æ–¥—ã | üí∞ –ü–ª–∞—Ç–µ–∂–∏
   üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
   ```
3. –ù–∞–∂–º–∏—Ç–µ **"üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞"**
4. –ü–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º Dashboard –∏ –∫–Ω–æ–ø–∫–æ–π **"üìä –û—Ç–∫—Ä—ã—Ç—å Analytics Dashboard"**
5. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É - –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Mini App —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏

#### –°–ø–æ—Å–æ–± 2: –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É `/analytics`
2. –°—Ä–∞–∑—É –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ **"üìä –û—Ç–∫—Ä—ã—Ç—å Analytics Dashboard"**
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É - –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Dashboard

### 3. –ó–∞—â–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞

#### AdminOnlyMiddleware
–í—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞—â–∏—â–µ–Ω—ã middleware, –∫–æ—Ç–æ—Ä—ã–π:

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `user_id` –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
2. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å `settings.admin_telegram_ids`
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–ø–∏—Å–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:
   ```
   ‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º.
   –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é –±–æ—Ç–∞.
   ```

Middleware –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫:
- `admin.router.message` - –∫–æ–º–∞–Ω–¥—ã —Ç–∏–ø–∞ `/admin`, `/analytics`
- `admin.router.callback_query` - callback'–∏ —Ç–∏–ø–∞ `admin:analytics`, `admin:menu`

#### API Endpoints –∑–∞—â–∏—Ç–∞
‚ö†Ô∏è **TODO:** API endpoints `/api/admin/analytics/*` –ø–æ–∫–∞ –Ω–µ –∏–º–µ—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å middleware –∏–ª–∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. Telegram WebApp initData
2. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ —á–µ—Ä–µ–∑ Bot Token
3. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ user_id –∏–∑ initData –µ—Å—Ç—å –≤ admin_telegram_ids

**–§–∞–π–ª:** `bot/handlers/api.py`, —Å—Ç—Ä–æ–∫–∞ 1465:
```python
# TODO: Add admin authentication middleware
```

## üìä –ß—Ç–æ –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω –≤ Dashboard

### Overview (–û–±–∑–æ—Ä)
- **DAU/WAU/MAU** - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- **–ù–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞ –ø–µ—Ä–∏–æ–¥
- **–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏** - Premium –º–∞—Å—Ç–µ—Ä–∞

### Retention (–£–¥–µ—Ä–∂–∞–Ω–∏–µ)
–ì—Ä–∞—Ñ–∏–∫ —É–¥–µ—Ä–∂–∞–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤:
- **Day 1** - –ø—Ä–æ—Ü–µ–Ω—Ç –≤–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è —á–µ—Ä–µ–∑ –¥–µ–Ω—å
- **Day 7** - —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é
- **Day 30** - —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü

### Cohorts (–ö–æ–≥–æ—Ä—Ç—ã)
–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∫–æ–≥–æ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ü—Ä–æ—Ü–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ–¥–µ–ª–∏
- –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è (–∑–µ–ª–µ–Ω—ã–π = –≤—ã—Å–æ–∫–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ)

### Funnel (–í–æ—Ä–æ–Ω–∫–∞)
–í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (5 —ç—Ç–∞–ø–æ–≤):
1. **Registered** - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å
2. **Onboarded** - –ø—Ä–æ—à–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
3. **Added Service** - –¥–æ–±–∞–≤–∏–ª–∏ —É—Å–ª—É–≥—É
4. **Got First Appointment** - –ø–æ–ª—É—á–∏–ª–∏ –∑–∞–ø–∏—Å—å
5. **Subscribed** - –æ—Ñ–æ—Ä–º–∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### URL Dashboard
```
{webapp_base_url}/webapp/admin/analytics.html
```

Where `webapp_base_url` –±–µ—Ä–µ—Ç—Å—è –∏–∑:
- `.env` —Ñ–∞–π–ª: `WEBAPP_BASE_URL=https://your-domain.com`
- Fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: `http://localhost:8080`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
```
webapp/admin/
‚îú‚îÄ‚îÄ analytics.html  - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Dashboard (4 –≤–∫–ª–∞–¥–∫–∏)
‚îú‚îÄ‚îÄ analytics.js    - –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ Chart.js
‚îî‚îÄ‚îÄ analytics.css   - Telegram-—Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è
```

### API Endpoints
Dashboard –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫:
```
GET /api/admin/analytics/retention  - –î–∞–Ω–Ω—ã–µ –ø–æ —É–¥–µ—Ä–∂–∞–Ω–∏—é
GET /api/admin/analytics/cohorts    - –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
GET /api/admin/analytics/funnel     - –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
GET /api/admin/analytics/growth     - –ú–µ—Ç—Ä–∏–∫–∏ —Ä–æ—Å—Ç–∞
```

### Telegram WebApp SDK
Dashboard –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
```javascript
let tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
```

–î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.

## üöÄ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–∞—Å—Ç–µ—Ä–∞)
```
User ‚Üí /admin
Bot ‚Üí ‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º.
```

### –î–ª—è –∞–¥–º–∏–Ω–∞
```
Admin ‚Üí /admin
Bot ‚Üí üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å BeautyAssist
      üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
      üë• –í—Å–µ–≥–æ –º–∞—Å—Ç–µ—Ä–æ–≤: 150
      ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ (30–¥): 45
      ...
      [–ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é]

Admin ‚Üí [–ù–∞–∂–∏–º–∞–µ—Ç "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞"]
Bot ‚Üí üìä Analytics Dashboard
      –û—Ç–∫—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...
      [üìä –û—Ç–∫—Ä—ã—Ç—å Analytics Dashboard]

Admin ‚Üí [–ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É]
‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Mini App —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
```

### –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø
```
Admin ‚Üí /analytics
Bot ‚Üí üìä Analytics Dashboard
      –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...
      [üìä –û—Ç–∫—Ä—ã—Ç—å Analytics Dashboard]

Admin ‚Üí [–ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É]
‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Mini App
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. HTTPS –¥–ª—è Production
Telegram —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è WebApp –≤ production. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP, –Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ –Ω—É–∂–µ–Ω SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.

### 2. –ó–∞—â–∏—Ç–∞ API
‚ö†Ô∏è **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å authentication middleware –¥–ª—è API endpoints –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º!

–ë–µ–∑ —ç—Ç–æ–≥–æ –ª—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å:
```
https://your-domain.com/webapp/admin/analytics.html
```

–ò —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –∑–Ω–∞–µ—Ç URL).

### 3. CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `bot/main.py` –Ω–∞—Å—Ç—Ä–æ–µ–Ω CORS –¥–ª—è aiohttp:

```python
from aiohttp_cors import setup as setup_cors

# –í —Ñ—É–Ω–∫—Ü–∏–∏ setup_webapp():
cors = setup_cors(app, defaults={
    "*": ResourceOptions(
        allow_credentials=True,
        expose_headers="*",
        allow_headers="*",
        allow_methods="*"
    )
})

for route in list(app.router.routes()):
    cors.add(route)
```

## üìù TODO: –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **API Authentication Middleware**
   ```python
   async def admin_auth_middleware(request):
       init_data = request.headers.get('X-Telegram-Init-Data')
       if not validate_telegram_webapp_data(init_data, bot_token):
           return web.json_response({'error': 'Unauthorized'}, status=401)
       
       user_id = extract_user_id(init_data)
       if user_id not in settings.admin_telegram_ids:
           return web.json_response({'error': 'Forbidden'}, status=403)
   ```

2. **Rate Limiting**
   –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ analytics endpoints (–Ω–∞–ø—Ä–∏–º–µ—Ä, 60 req/min).

3. **Audit Log**
   –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –∞–¥–º–∏–Ω API:
   - –ö—Ç–æ (user_id)
   - –ö–æ–≥–¥–∞ (timestamp)
   - –ß—Ç–æ (endpoint)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è API authentication middleware
