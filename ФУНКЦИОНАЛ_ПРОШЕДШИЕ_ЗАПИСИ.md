# ‚è∞ –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—à–µ–¥—à–∏—Ö –∑–∞–ø–∏—Å–µ–π

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä—É

–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ **9:00** –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å—è—Ö:
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—à–µ–¥—à–∏–µ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
- –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ –¥–∞—Ç–∞–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- –°–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–¥–æ 5 –∑–∞–ø–∏—Å–µ–π)

### ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π

–ú–∞—Å—Ç–µ—Ä –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø–∏—Å—å **–ø—Ä—è–º–æ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
1. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å –∏–º–µ–Ω–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
2. –í—ã–±–∏—Ä–∞–µ—Ç: "–ü—Ä–∏—à—ë–ª" –∏–ª–∏ "–ù–µ –ø—Ä–∏—à—ë–ª"
3. –ï—Å–ª–∏ –ø—Ä–∏—à—ë–ª ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –ó–∞–ø–∏—Å—å –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è
   - –û–ø–ª–∞—Ç–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è (—Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–∑–∏—Ç–æ–≤, —Å—É–º–º–∞)

### ‚úÖ –ü–æ–∏—Å–∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ `AppointmentRepository`:
```python
async def get_past_incomplete(
    master_id: Optional[int] = None,
    before_time: Optional[datetime] = None
) -> List[Appointment]
```

–ù–∞—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ:
- –ü—Ä–æ—à–ª–∏ (start_time < —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
- –ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã (is_completed = False)
- –ò–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å "scheduled" –∏–ª–∏ "confirmed"

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **AppointmentRepository.get_past_incomplete()** (`database/repositories/appointment.py`)
   - –ü–æ–∏—Å–∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø—Ä–æ—à–µ–¥—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–∞—Å—Ç–µ—Ä—É
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)

2. **notify_masters_incomplete_appointments()** (`services/incomplete_checker.py`)
   - –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –º–∞—Å—Ç–µ—Ä–∞–º
   - –ù–∞—Ö–æ–¥–∏—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram

3. **Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** (`bot/main.py`)
   - `complete_appt:ID` ‚Äî –Ω–∞—á–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
   - `confirm_came:ID` ‚Äî –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—à—ë–ª (–∑–∞–≤–µ—Ä—à–∏—Ç—å —Å –æ–ø–ª–∞—Ç–æ–π)
   - `confirm_noshow:ID` ‚Äî –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–∏—à—ë–ª (–æ—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É)
   - `cancel_action` ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ

4. **APScheduler task** (`bot/main.py`)
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 9:00
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## –ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```
‚ö†Ô∏è –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏

–£ –≤–∞—Å –µ—Å—Ç—å 3 –∑–∞–ø–∏—Å–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å:

03.12.2025
  ‚Ä¢ 14:00 ‚Äî –ú–∞–Ω–∏–∫—é—Ä ‚Äî –ê–Ω–Ω–∞
  ‚Ä¢ 17:30 ‚Äî –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π ‚Äî –ú–∞—Ä–∏—è

02.12.2025
  ‚Ä¢ 19:00 ‚Äî –†–µ—Å–Ω–∏—Ü—ã ‚Äî –û–ª—å–≥–∞

üí° –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–±–∏–Ω–µ—Ç –º–∞—Å—Ç–µ—Ä–∞.

[‚úì 14:00 –ê–Ω–Ω–∞]
[‚úì 17:30 –ú–∞—Ä–∏—è]
[‚úì 19:00 –û–ª—å–≥–∞]
```

## –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### –®–∞–≥ 1: –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏
–ú–∞—Å—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å –∏–º–µ–Ω–µ–º –∫–ª–∏–µ–Ω—Ç–∞:
```
üìã –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø–∏—Å—å?

–ö–ª–∏–µ–Ω—Ç: –ê–Ω–Ω–∞
–£—Å–ª—É–≥–∞: –ú–∞–Ω–∏–∫—é—Ä
–í—Ä–µ–º—è: 03.12.2025 14:00

–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏—à—ë–ª?

[‚úÖ –ü—Ä–∏—à—ë–ª]  [‚ùå –ù–µ –ø—Ä–∏—à—ë–ª]
     [üîô –û—Ç–º–µ–Ω–∞]
```

### –®–∞–≥ 2–∞: –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏—à—ë–ª
```
‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞

–ö–ª–∏–µ–Ω—Ç: –ê–Ω–Ω–∞
–û–ø–ª–∞—Ç–∞: 1500 ‚ÇΩ
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- `appointment.status` ‚Üí "completed"
- `appointment.is_completed` ‚Üí true
- `appointment.payment_amount` ‚Üí —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏
- `client.total_visits` += 1
- `client.total_spent` += payment_amount
- `client.last_visit` = –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏

### –®–∞–≥ 2–±: –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–∏—à—ë–ª
```
‚ùå –û—Ç–º–µ—á–µ–Ω–æ: –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–∏—à—ë–ª

–ö–ª–∏–µ–Ω—Ç: –ê–Ω–Ω–∞
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- `appointment.status` ‚Üí "no_show"
- `appointment.is_completed` ‚Üí true
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

–í `bot/main.py`:
```python
reminder_scheduler.add_job(
    check_incomplete_appointments,
    'cron',
    hour=9,       # 9:00 AM
    minute=0,
    id='incomplete_checker',
    replace_existing=True
)
```

–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∏–∑–º–µ–Ω–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä `hour`.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç:
```bash
$env:PYTHONPATH="D:\Projects\BeautyAssist"
python tests/test_incomplete.py
```

–¢–µ—Å—Ç:
1. –ù–∞—Ö–æ–¥–∏—Ç –º–∞—Å—Ç–µ—Ä–∞
2. –ò—â–µ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
3. –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—É—é (2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥)
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (mock)

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–í –∫–æ–Ω—Å–æ–ª–∏ –±–æ—Ç–∞:
- `‚è∞ Incomplete appointments checker scheduled (daily at 9:00 AM)` ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- `‚úÖ Notified N masters about incomplete appointments` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–æ N –º–∞—Å—Ç–µ—Ä–æ–≤

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Äî –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –≤–æ–≤—Ä–µ–º—è
2. **–ù–µ –∑–∞–±—ã—Ç—å –ø—Ä–æ –æ–ø–ª–∞—Ç—É** ‚Äî –º–∞—Å—Ç–µ—Ä —Å—Ä–∞–∑—É —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø–ª–∞—Ç—ë–∂
3. **–ë—ã—Å—Ç—Ä–æ—Ç–∞** ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞ 2 –∫–ª–∏–∫–∞ –ø—Ä—è–º–æ –∏–∑ Telegram
4. **–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–µ—è–≤–æ–∫** ‚Äî –≤–∏–¥–Ω–æ, –∫—Ç–æ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
5. **–ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤** ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –≤–∏–∑–∏—Ç–∞—Ö

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–º
- [ ] –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º (–µ—Å–ª–∏ –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π)
- [ ] –ö–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –∑–∞ –¥–µ–Ω—å" —Å –æ–¥–Ω–æ–π —Ü–µ–Ω–æ–π
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ—è–≤–æ–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
- [ ] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ N —á–∞—Å–æ–≤, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ Excel
