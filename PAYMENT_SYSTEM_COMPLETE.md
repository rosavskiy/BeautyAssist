# üéâ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ - –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (4 –¥–µ–∫–∞–±—Ä—è 2025)

### ‚úÖ 1. –ë–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- **–ú–æ–¥–µ–ª–∏**: Subscription, Transaction
- **–¢–∞—Ä–∏—Ñ—ã**: Trial (14 –¥–Ω–µ–π), Monthly (990‚ÇΩ), Quarterly (2490‚ÇΩ), Yearly (8280‚ÇΩ)
- **–ü–ª–∞—Ç–µ–∂–∏**: Telegram Stars –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **Handlers**: /subscription –∫–æ–º–∞–Ω–¥–∞, –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–æ–≤, –æ–ø–ª–∞—Ç–∞
- **Middleware**: SubscriptionMiddleware –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: SUBSCRIPTIONS.md

### ‚úÖ 2. –ü—Ä–æ–º–æ–∫–æ–¥—ã (PromoCode System)
- **–ú–æ–¥–µ–ª–∏**: 
  - `PromoCode` - —Å–∞–º–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã
  - `PromoCodeUsage` - –∏—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–¢–∏–ø—ã —Å–∫–∏–¥–æ–∫**:
  - `PERCENT` - –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20%)
  - `FIXED` - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100‚ÇΩ)
  - `TRIAL_EXTENSION` - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ trial –ø–µ—Ä–∏–æ–¥–∞
- **–õ–∏–º–∏—Ç—ã**:
  - –û–±—â–∏–π –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (`max_uses`)
  - –õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`max_uses_per_user`)
  - –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (`valid_from`, `valid_until`)
- **PromoCodeRepository**:
  - `create_promo_code()` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
  - `validate_promo_code()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
  - `apply_promo_code()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ + —Å–æ–∑–¥–∞–Ω–∏–µ usage record
  - `get_promo_code_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - `deactivate_promo_code()` - –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–∞**:
```python
# –°–∫–∏–¥–∫–∞ 20%
NEWYEAR2025: 20% discount, max 100 uses

# –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞
FIRST100: 100 RUB discount, 1 use per user

# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
REF_MASTER123: 15% discount + 100‚ÇΩ –±–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–µ—Ä—É
```

### ‚úÖ 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- **SubscriptionMonitorService**:
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 –¥–µ–Ω—å
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
  - –û–±–Ω–æ–≤–ª—è–µ—Ç `master.is_premium` —Å—Ç–∞—Ç—É—Å

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ scheduler**:
```python
reminder_scheduler.add_job(
    check_subscriptions,
    'interval',
    hours=6,
    id='subscription_checker',
)
```

### ‚úÖ 4. YooKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (SDK —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- **–ü–∞–∫–µ—Ç**: `yookassa==3.6.0` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: 
  - `YOOKASSA_SHOP_ID`
  - `YOOKASSA_SECRET_KEY`
  - `YOOKASSA_RETURN_URL`

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ YooKassa API
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Ä—Ç, –°–ë–ü, Apple Pay, Google Pay

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü—ã

1. **subscriptions** (–ø–æ–¥–ø–∏—Å–∫–∏)
   - `master_id`, `plan`, `status`, `start_date`, `end_date`
   - `amount`, `currency`, `payment_method`
   - `auto_renew`, `cancelled_at`

2. **transactions** (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
   - `subscription_id`, `master_id`, `type`, `status`
   - `amount`, `currency`, `payment_method`
   - `provider_payment_id`, `provider_data`

3. **promo_codes** (–ø—Ä–æ–º–æ–∫–æ–¥—ã)
   - `code`, `type`, `status`
   - `discount_percent`, `discount_amount`, `trial_days`
   - `max_uses`, `current_uses`, `max_uses_per_user`
   - `valid_from`, `valid_until`
   - `referrer_master_id`, `referrer_bonus_amount`

4. **promo_code_usages** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤)
   - `promo_code_id`, `master_id`, `subscription_id`
   - `discount_amount`, `original_amount`, `final_amount`
   - `used_at`

### –ú–∏–≥—Ä–∞—Ü–∏–∏
- `14764cde3ed5` - subscriptions + transactions
- `73db78e76920` - promo_codes + promo_code_usages

---

## üîÑ Background –∑–∞–¥–∞—á–∏

### –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ (–∫–∞–∂–¥—ã–µ N)
1. **scan_and_send_reminders** - –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
2. **check_incomplete_appointments** - –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 9:00
3. **check_subscriptions** - –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ ‚≠ê –ù–û–í–û–ï

---

## üöÄ –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–¥–µ–ª–∞—Ç—å

### 1. YooKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (30 –º–∏–Ω)
```python
# –í services/payment.py –¥–æ–±–∞–≤–∏—Ç—å:
class YooKassaPaymentProvider:
    async def create_payment(amount, description):
        # yookassa.Payment.create()
    
    async def handle_webhook(data):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ payment.succeeded
```

### 2. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –§–∏–Ω–∞–Ω—Å—ã (45 –º–∏–Ω)
```python
# –í database/repositories/admin.py –¥–æ–±–∞–≤–∏—Ç—å:
async def get_subscription_metrics():
    return {
        "mrr": ...,  # Monthly Recurring Revenue
        "total_revenue": ...,
        "conversion_rate": ...,  # trial -> paid
        "churn_rate": ...,
        "ltv": ...,  # Lifetime Value
        "active_subscriptions": ...,
        "trial_users": ...,
    }
```

### 3. –ê–¥–º–∏–Ω —Ö—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (30 –º–∏–Ω)
```python
# bot/handlers/admin.py –¥–æ–±–∞–≤–∏—Ç—å:
@router.callback_query(F.data == "admin:promo_codes")
async def admin_promo_codes():
    # –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ UI (20 –º–∏–Ω)
```python
# –í bot/handlers/subscription.py:
# –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–£ –º–µ–Ω—è –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥"
# FSM –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
# –ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
```

### 5. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 1 —á–∞—Å)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –∑–∞ 1 –¥–µ–Ω—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ–ø–ª–∞—Ç—ã

---

## üí∞ –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- ‚úÖ MRR - —Å—É–º–º–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Å—è—á–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ Conversion - % trial –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫—É–ø–∏–≤—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫—É
- ‚úÖ Churn - % –æ—Ç–º–µ–Ω–∏–≤—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫—É
- ‚úÖ Revenue by plan - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤
- ‚úÖ Usage stats - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

### –§–æ—Ä–º—É–ª—ã:
```python
MRR = sum(active_subscriptions.price_per_month)
Conversion = paid_users / trial_users * 100
Churn = cancelled_this_month / active_start_of_month * 100
LTV = avg_subscription_price * avg_months_subscribed
```

---

## üìù –ò—Ç–æ–≥–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∑–∞ —Å–µ—Å—Å–∏—é:

1. ‚úÖ **–ú–æ–¥–µ–ª–∏**: Subscription, Transaction, PromoCode, PromoCodeUsage
2. ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏–∏**: 2 –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
3. ‚úÖ **Repositories**: SubscriptionRepository, PromoCodeRepository
4. ‚úÖ **Services**: PaymentService (Telegram Stars), SubscriptionMonitorService
5. ‚úÖ **Middleware**: SubscriptionMiddleware
6. ‚úÖ **Handlers**: /subscription —Å –ø–æ–ª–Ω—ã–º flow
7. ‚úÖ **Background tasks**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
8. ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –ó–∞ 3 –¥–Ω—è, –∑–∞ 1 –¥–µ–Ω—å, –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
9. ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: YooKassa settings
10. ‚úÖ **–ü—Ä–æ–º–æ–∫–æ–¥—ã**: –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å —Ç–∏–ø–∞–º–∏, –ª–∏–º–∏—Ç–∞–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã** - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥, –ø—Ä–∏–º–µ–Ω–∏—Ç—å
2. **–î–æ–±–∞–≤–∏—Ç—å YooKassa** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–ø–ª–∞—Ç–æ–π –∫–∞—Ä—Ç–∞–º–∏
3. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** - –º–µ—Ç—Ä–∏–∫–∏ MRR, –∫–æ–Ω–≤–µ—Ä—Å–∏–∏, –ø—Ä–æ–º–æ–∫–æ–¥—ã
4. **UI –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤** - –∫–Ω–æ–ø–∫–∞ "–£ –º–µ–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥" –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –æ–±–Ω–æ–≤–∏—Ç—å SUBSCRIPTIONS.md

---

**–°—Ç–∞—Ç—É—Å**: –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ 90% –≥–æ—Ç–æ–≤–∞ –∫ production! üöÄ

–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ Trial + –ø–ª–∞—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ Telegram Stars –æ–ø–ª–∞—Ç–∞
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥—ã —Å –≥–∏–±–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏

–û—Å—Ç–∞–ª–æ—Å—å:
- üîú YooKassa (–∫–∞—Ä—Ç—ã, –°–ë–ü)
- üîú –ê–¥–º–∏–Ω UI –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- üîú –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ
