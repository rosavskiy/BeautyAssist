# Схема доступа к Admin Analytics Dashboard

## 📋 Краткий ответ на ваш вопрос

**Вопрос:** Как происходит открытие админ панели? Также по кнопке Кабинет, только у админа есть дополнительная ссылка на страницу?

**Ответ:** Нет, это **отдельная система доступа** через административные команды:

### 🔑 Для мастера (обычный пользователь)
```
Кнопка "Кабинет" → webapp/master/*.html
```
- Управление услугами
- Записи клиентов
- Финансы

### 👑 Для админа
```
/admin → Меню → "📈 Аналитика" → webapp/admin/analytics.html
```
ИЛИ
```
/analytics → webapp/admin/analytics.html
```

## 🔄 Полная схема доступа

```
┌─────────────────────────────────────────────────────┐
│                   TELEGRAM BOT                       │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │   Проверка user_id            │
         │   в ADMIN_TELEGRAM_IDS        │
         └───────────────────────────────┘
                │                  │
        ┌───────┘                  └───────┐
        │ НЕТ                              │ ДА
        ▼                                  ▼
┌──────────────────┐           ┌──────────────────────┐
│  Обычный мастер  │           │      Админ           │
└──────────────────┘           └──────────────────────┘
        │                                  │
        ▼                                  ▼
┌──────────────────┐           ┌──────────────────────┐
│ Кнопка "Кабинет" │           │    /admin или        │
│ (всегда видна)   │           │    /analytics        │
└──────────────────┘           └──────────────────────┘
        │                                  │
        ▼                                  ▼
┌──────────────────┐           ┌──────────────────────┐
│  Master WebApp   │           │   Admin Menu         │
│  /master/*.html  │           │   [Кнопки]           │
└──────────────────┘           └──────────────────────┘
        │                                  │
        ├─► services.html                 ├─► "📈 Аналитика"
        ├─► appointments.html             │
        └─► finances.html                 ▼
                                ┌──────────────────────┐
                                │   WebApp Button      │
                                │ "📊 Открыть Dashboard"│
                                └──────────────────────┘
                                          │
                                          ▼
                                ┌──────────────────────┐
                                │  /webapp/admin/       │
                                │  analytics.html      │
                                └──────────────────────┘
                                          │
                                          ▼
                        ┌─────────────────────────────────┐
                        │   Chart.js Graphs:              │
                        │   • Retention                   │
                        │   • Cohorts                     │
                        │   • Funnel                      │
                        │   • Growth                      │
                        └─────────────────────────────────┘
```

## 🔐 Защита доступа

### 1. Команды бота
```python
# bot/middlewares/admin.py
class AdminOnlyMiddleware:
    async def __call__(self, handler, event, data):
        if user_id not in settings.admin_telegram_ids:
            return "❌ У вас нет доступа"
        return await handler(event, data)
```

### 2. API Endpoints (⚠️ TODO)
```python
# bot/handlers/api.py - НУЖНО ДОБАВИТЬ
@admin_required
async def get_retention_analytics(request):
    # Проверка Telegram WebApp initData
    # Проверка user_id в admin_telegram_ids
    ...
```

## 📱 Пример использования

### Сценарий 1: Мастер пытается открыть /admin
```
Мастер: /admin
Бот: ❌ У вас нет доступа к административным командам.
     Эта функция доступна только создателю бота.
```

### Сценарий 2: Админ открывает Analytics Dashboard
```
Админ: /admin
Бот: 🔧 Админ-панель BeautyAssist
     
     📊 Статистика:
     👥 Всего мастеров: 150
     ✅ Активных мастеров (30д): 45
     👤 Всего клиентов: 1250
     
     [📊 Dashboard] [👥 Мастера] [📣 Рассылка]
     [🎫 Промокоды] [💰 Платежи]
     [📈 Аналитика] ← НАЖАТЬ
     
→ Админ нажимает "📈 Аналитика"

Бот: 📊 Analytics Dashboard
     
     Откройте интерактивную панель аналитики с графиками:
     
     📈 Retention - удержание мастеров (Day 1/7/30)
     👥 Cohorts - когортный анализ по неделям
     🎯 Funnel - воронка конверсии (5 этапов)
     📊 Growth - метрики роста (DAU/WAU/MAU)
     
     [📊 Открыть Analytics Dashboard] ← НАЖАТЬ
     [🔙 Назад в меню]
     
→ Админ нажимает кнопку WebApp

→ Открывается Mini App: https://your-domain.com/admin/analytics.html
```

### Сценарий 3: Быстрый доступ
```
Админ: /analytics
Бот: 📊 Analytics Dashboard
     
     Интерактивная панель аналитики с графиками:
     
     📈 Retention • 👥 Cohorts • 🎯 Funnel • 📊 Growth
     
     [📊 Открыть Analytics Dashboard] ← НАЖАТЬ
     
→ Открывается Mini App сразу
```

## 🆚 Различия: Мастер vs Админ

| Аспект | Мастер | Админ |
|--------|--------|-------|
| **Доступ к боту** | Кнопка "Кабинет" | Команды `/admin`, `/analytics` |
| **WebApp URL** | `/webapp/master/*.html` | `/webapp/admin/*.html` |
| **Функционал** | Управление своими услугами/записями | Аналитика всех пользователей |
| **Проверка прав** | Нет (любой мастер) | `AdminOnlyMiddleware` |
| **Данные** | Только свои | Все мастера + клиенты |
| **Кнопки меню** | Услуги, Записи, Клиенты, Финансы | Dashboard, Мастера, Рассылка, Аналитика |

## ⚙️ Конфигурация

### .env файл
```env
# Мастер WebApp (для всех)
WEBAPP_BASE_URL=https://your-domain.com

# Админы (через запятую)
ADMIN_TELEGRAM_IDS=123456789,987654321
```

### Получить свой Telegram ID
1. Отправьте `/start` боту @userinfobot
2. Скопируйте `Id: 123456789`
3. Добавьте в `.env`

## 🎯 Итого

1. **Мастер** → Кнопка "Кабинет" → `/webapp/master/services.html`
2. **Админ** → `/admin` → "📈 Аналитика" → `/webapp/admin/analytics.html`
3. **Админ** → `/analytics` → `/webapp/admin/analytics.html` (быстрый доступ)

**Два разных интерфейса:**
- `/webapp/master/*` - для управления своим бизнесом
- `/webapp/admin/*` - для мониторинга всей платформы

---

**См. также:**
- `ADMIN_ANALYTICS_ACCESS.md` - подробная документация
- `TESTING_SERVICES_MIGRATION.md` - тестирование Master WebApp
- `bot/handlers/admin.py` - код обработчиков
- `bot/middlewares/admin.py` - проверка прав доступа
