# üéÅ Auto-Trial Activation - –£–ª—É—á—à–µ–Ω–∏–µ UX

## –ü—Ä–æ–±–ª–µ–º–∞ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–ª –≤ **deadlock**:
1. –ü—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–π—Ç–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ (–≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥)
2. Middleware –±–ª–æ–∫–∏—Ä—É–µ—Ç: "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞"
3. –ù–æ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω—É–∂–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –∏ —É—Ö–æ–¥–∏—Ç ‚ùå

## –†–µ—à–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
–ü—Ä–∏ –ø–µ—Ä–≤–æ–º `/start` –Ω–æ–≤–æ–º—É –º–∞—Å—Ç–µ—Ä—É **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è Trial –Ω–∞ 30 –¥–Ω–µ–π**:

```
üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ BeautyAssist!

üéÅ –í–∞–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–∞ 30 –¥–Ω–µ–π!
–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ.

–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤:
```

### –§–ª–æ—É –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. `/start` ‚Üí –ê–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è trial ‚úÖ
2. –û–Ω–±–æ—Ä–¥–∏–Ω–≥: –≥–æ—Ä–æ–¥, –≥—Ä–∞—Ñ–∏–∫, —É—Å–ª—É–≥–∏ ‚úÖ
3. 30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
4. –ó–∞ 3 –¥–Ω—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
5. –í—ã–±–æ—Ä –ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. `bot/handlers/onboarding.py`
–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–∞:

```python
if not master:
    # Create new master
    master = await mrepo.create(...)
    
    # Auto-activate trial
    from database.repositories.subscription import SubscriptionRepository
    from services.payment import PaymentService
    
    sub_repo = SubscriptionRepository(session)
    if await sub_repo.is_trial_available(master.id):
        payment_service = PaymentService(message.bot)
        await payment_service.activate_trial(
            master_id=master.id,
            telegram_id=message.from_user.id,
            session=session,
        )
```

### 2. `bot/middlewares/subscription.py`
–î–æ–±–∞–≤–ª–µ–Ω—ã –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:

```python
ALLOWED_CALLBACKS = {
    'subscription:',   # Subscription management
    'setup_city:',     # Onboarding: city selection üÜï
    'setup_schedule:', # Onboarding: schedule setup üÜï
    'setup_service:',  # Onboarding: service management üÜï
}
```

### 3. –¢–µ—Å—Ç—ã `tests/test_trial_activation.py`
–°–æ–∑–¥–∞–Ω–æ 3 —Ç–µ—Å—Ç–∞:
- ‚úÖ –ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç trial –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ Active trial –¥–∞—ë—Ç –¥–æ—Å—Ç—É–ø
- ‚úÖ Expired trial –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- ‚úÖ –ù–µ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- ‚úÖ –°—Ä–∞–∑—É –≤–∏–¥–∏—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å "–≥–¥–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"
- ‚úÖ 30 –¥–Ω–µ–π —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç

### –î–ª—è –±–∏–∑–Ω–µ—Å–∞:
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ bounce rate
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ conversion (trial ‚Üí paid)
- ‚úÖ –õ—É—á—à–∏–π first impression
- ‚úÖ –ú–µ–Ω—å—à–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ("–≥–¥–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å?")

## –î–æ vs –ü–æ—Å–ª–µ

### ‚ùå –î–æ (–ü–ª–æ—Ö–æ–π UX):
```
User: /start
Bot: –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥
User: –ú–æ—Å–∫–≤–∞
Bot: ‚õî –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /subscription
User: /subscription
Bot: –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∏–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥
User: [–Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥"]
Bot: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω trial
User: [–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É... –Ω–æ –∫–∞–∫?] üòï
```

### ‚úÖ –ü–æ—Å–ª–µ (–•–æ—Ä–æ—à–∏–π UX):
```
User: /start
Bot: üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
     üéÅ –í–∞–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–∞ 30 –¥–Ω–µ–π!
     –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:
User: –ú–æ—Å–∫–≤–∞
Bot: ‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã...
[–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º] üòä
```

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 15 –º–∏–Ω—É—Ç
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~20 —Å—Ç—Ä–æ–∫
- **–¢–µ—Å—Ç–æ–≤**: 3 (–≤—Å–µ passed)
- **–£–ª—É—á—à–µ–Ω–∏–µ UX**: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ
- **–†–∏—Å–∫–∏**: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (trial –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ—Å—Ç–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å **–æ–≥—Ä–æ–º–Ω—ã–º –≤–ª–∏—è–Ω–∏–µ–º –Ω–∞ UX**:
- –£–±–∏—Ä–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π –±–∞—Ä—å–µ—Ä –≤—Ö–æ–¥–∞
- –î–µ–ª–∞–µ—Ç onboarding –ø–ª–∞–≤–Ω—ã–º
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –æ–ø—ã—Ç —Å –ø–µ—Ä–≤–æ–π —Å–µ–∫—É–Ω–¥—ã üöÄ
