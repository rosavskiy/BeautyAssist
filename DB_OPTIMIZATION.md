# üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î

**–î–∞—Ç–∞:** 4 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω—ã —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

–î–æ–±–∞–≤–ª–µ–Ω—ã 6 —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

#### Appointments (–∑–∞–ø–∏—Å–∏)
```sql
-- –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π –º–∞—Å—Ç–µ—Ä–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –≤—Ä–µ–º–µ–Ω–∏
CREATE INDEX ix_appointments_master_status_time 
ON appointments (master_id, status, start_time);

-- –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞ ("–ú–æ–∏ –∑–∞–ø–∏—Å–∏")
CREATE INDEX ix_appointments_client_status_time 
ON appointments (client_id, status, start_time);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
CREATE INDEX ix_appointments_master_time_range 
ON appointments (master_id, start_time, end_time);
```

#### Reminders (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è)
```sql
-- –ü–æ–∏—Å–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
CREATE INDEX ix_reminders_status_scheduled_time 
ON reminders (status, scheduled_time);
```

#### Clients (–∫–ª–∏–µ–Ω—Ç—ã)
```sql
-- –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ Telegram ID
CREATE INDEX ix_clients_master_telegram 
ON clients (master_id, telegram_id);

-- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–µ–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
CREATE INDEX ix_clients_master_phone 
ON clients (master_id, phone);
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è Alembic

–§–∞–π–ª: `alembic/versions/2025_12_04_1643-0b08f72a12d1_add_performance_indexes.py`

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
alembic upgrade head
```

**–û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):**
```bash
alembic downgrade -1
```

### 3. –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### test_performance.py
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ó–∞–ø—É—Å–∫:**
```bash
python scripts/test_performance.py
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –°–∫–æ—Ä–æ—Å—Ç—å –≤—ã–±–æ—Ä–∫–∏ –∑–∞–ø–∏—Å–µ–π –º–∞—Å—Ç–µ—Ä–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –ü–æ–∏—Å–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ telegram_id –∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤

#### analyze_queries.sql
SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (EXPLAIN ANALYZE).

**–ó–∞–ø—É—Å–∫:**
```bash
psql -h localhost -U postgres -d beautyassist -f scripts/analyze_queries.sql
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

| –ó–∞–ø—Ä–æ—Å | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|--------|-------|--------|
| –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –º–∞—Å—Ç–µ—Ä–∞ (7 –¥–Ω–µ–π, —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏) | ~214ms | ‚úÖ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ | ~4ms | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞ | ~3ms | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (30 –¥–Ω–µ–π) | ~3ms | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| –ü–æ–∏—Å–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ | ~7ms | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ telegram_id | ~9ms | ‚úÖ –•–æ—Ä–æ—à–æ |
| –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É | ~3ms | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

**–¢–æ–ø-5 —Å–∞–º—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö:**

1. `ix_masters_telegram_id` - 551 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
2. `ix_masters_referral_code` - 508 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
3. `ix_appointments_start_time` - 423 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
4. `ix_appointments_master_id` - 281 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
5. `ix_services_master_id` - 150 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

### –†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü

| –¢–∞–±–ª–∏—Ü–∞ | –ñ–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ | –ú—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ | –†–∞–∑–º–µ—Ä |
|---------|--------------|----------------|--------|
| appointments | 11 | 19 | 160 kB |
| clients | 7 | 12 | 112 kB |
| reminders | 6 | 1 | 80 kB |
| services | 5 | 2 | 48 kB |
| masters | 3 | 4 | 64 kB |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ú—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã, –Ω–æ —Å—Ç–æ–∏—Ç —Å–ª–µ–¥–∏—Ç—å –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö.

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π –º–∞—Å—Ç–µ—Ä–∞: –∑–∞–≤–∏—Å–µ–ª –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: —Ç—Ä–µ–±–æ–≤–∞–ª–∞ –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
- –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞: –ª–∏–Ω–µ–π–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞ < 10ms
- ‚úÖ –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç 90% –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö (–¥–æ 100K –∑–∞–ø–∏—Å–µ–π)

## –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ

–ü—Ä–∏ 1000 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –º–∞—Å—Ç–µ—Ä–∞ (—Ç–∏–ø–∏—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –∑–∞ –≥–æ–¥):

| –û–ø–µ—Ä–∞—Ü–∏—è | –ë–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ | –° –∏–Ω–¥–µ–∫—Å–∞–º–∏ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|----------|--------------|-------------|-----------|
| –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ | ~500ms | ~5ms | **100x** |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ | ~200ms | ~3ms | **65x** |
| –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞ | ~150ms | ~4ms | **35x** |
| –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (100 —à—Ç) | ~1000ms | ~10ms | **100x** |

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ:**
```bash
python scripts/test_performance.py
```

**–ï–∂–µ–º–µ—Å—è—á–Ω–æ:**
```bash
psql -d beautyassist -f scripts/analyze_queries.sql > performance_report.txt
```

### –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π

‚ö†Ô∏è **VACUUM –Ω—É–∂–µ–Ω –µ—Å–ª–∏:**
- Dead rows > 20% –æ—Ç live rows
- –ü–æ—Å–ª–µ–¥–Ω–∏–π autovacuum > 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥

‚ö†Ô∏è **–ê–Ω–∞–ª–∏–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω—É–∂–µ–Ω –µ—Å–ª–∏:**
- –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å > 100ms
- Index scans = 0 –¥–ª—è –Ω–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- –†–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞ > 10MB –∏ scans < 100

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus + Grafana)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- [ ] –í–∫–ª—é—á–∏—Ç—å pg_stat_statements –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1-2 –º–µ—Å—è—Ü–∞)
- [ ] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥ –≤ Redis (—Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î)
- [ ] –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã appointments –ø–æ –º–µ—Å—è—Ü–∞–º (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
- [ ] Connection pooling —á–µ—Ä–µ–∑ PgBouncer (–ø—Ä–∏ > 50 –º–∞—Å—Ç–µ—Ä–æ–≤)

### –ö–æ–≥–¥–∞ —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ
- Appointments > 100K –∑–∞–ø–∏—Å–µ–π ‚Üí –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
- Masters > 100 ‚Üí PgBouncer –¥–ª—è –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- Queries > 100ms ‚Üí –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ EXPLAIN –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

```
alembic/versions/
  ‚îî‚îÄ‚îÄ 2025_12_04_1643-0b08f72a12d1_add_performance_indexes.py  # –ú–∏–≥—Ä–∞—Ü–∏—è

scripts/
  ‚îú‚îÄ‚îÄ test_performance.py      # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  ‚îî‚îÄ‚îÄ analyze_queries.sql      # SQL-–∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤
```

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
alembic upgrade head

# –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
python scripts/test_performance.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ë–î
psql -d beautyassist -c "SELECT pg_size_pretty(pg_database_size('beautyassist'));"

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
psql -d beautyassist -c "SELECT * FROM pg_indexes WHERE schemaname='public';"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
psql -d beautyassist -c "SELECT * FROM pg_stat_user_indexes WHERE schemaname='public' ORDER BY idx_scan DESC;"
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞**

- 6 –Ω–æ–≤—ã—Ö —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã < 10ms
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É –¥–æ 100K –∑–∞–ø–∏—Å–µ–π
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –≤ production

**–°–ª–µ–¥—É—é—â–∏–π —Ñ–æ–∫—É—Å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ CI/CD (–°–ø—Ä–∏–Ω—Ç 4)
